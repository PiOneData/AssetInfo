name: Deploy AssetNext (App + DB)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin

      - name: ðŸ—ï¸ Build and push app image
        run: |
          USERNAME=$(echo "${{ secrets.GHCR_USERNAME }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME=ghcr.io/$USERNAME/assetnext:latest
          echo "ðŸ“¦ Building image: $IMAGE_NAME"
          docker build -t $IMAGE_NAME .
          docker push $IMAGE_NAME

      - name: ðŸš€ Deploy to remote server using docker-compose
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            USERNAME=$(echo "${{ secrets.GHCR_USERNAME }}" | tr '[:upper:]' '[:lower:]')
            APP_IMAGE=ghcr.io/$USERNAME/assetnext:latest
            
            echo "ðŸ§¹ Stopping existing containers..."
            docker-compose down || true
            
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f || true
            
            echo "ðŸ“¦ Pulling latest app image..."
            docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} -p ${{ secrets.GHCR_TOKEN }}
            docker pull $APP_IMAGE
            
            echo "ðŸ“ Creating .env file..."
            cat > .env << 'EOF'
            NODE_ENV=production
            PORT=5926
            HOST=0.0.0.0
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
            DATABASE_URL=postgresql://asset:${{ secrets.DB_PASSWORD }}@db:5432/assetnext
            POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
            OA_BASE_URL=${{ secrets.OA_BASE_URL }}
            OA_USERNAME=${{ secrets.OA_USERNAME }}
            OA_PASSWORD=${{ secrets.OA_PASSWORD }}
            PUBLIC_URL=${{ secrets.PUBLIC_URL }}
            AGENT_ENROLL_URL=${{ secrets.AGENT_ENROLL_URL }}
            CLIENT_URL=${{ secrets.CLIENT_URL }}
            PRODUCTION_URL=${{ secrets.PRODUCTION_URL }}
            EOF
            
            echo "ðŸ“ Creating docker-compose.yml file..."
            cat > docker-compose.yml << EOF
            services:
              app:
                image: $APP_IMAGE
                env_file:
                  - .env
                ports:
                  - "5926:5926"
                restart: unless-stopped
                environment:
                  - NODE_ENV=production
                  - PORT=5926
                depends_on:
                  - db
                healthcheck:
                  test: ["CMD", "wget", "-qO-", "http://localhost:5926/api/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
            
              db:
                image: postgres:15-alpine
                environment:
                  POSTGRES_USER: asset
                  POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
                  POSTGRES_DB: assetnext
                ports:
                  - "5928:5432"
                volumes:
                  - pgdata:/var/lib/postgresql/data
                restart: unless-stopped
            
            volumes:
              pgdata:
                driver: local
            EOF
            
            echo "ðŸš€ Starting services with docker-compose..."
            docker-compose up -d
            
            echo "â³ Waiting for services to be healthy..."
            sleep 30
            
            echo "ðŸ¥ Checking service health..."
            if docker-compose ps | grep -q "Up.*healthy"; then
              echo "âœ… Deployment successful! Services are healthy."
            else
              echo "âš ï¸  Services started but health check status unclear. Check manually."
              docker-compose ps
            fi
            
            echo "ðŸ“‹ Final status:"
            docker-compose ps